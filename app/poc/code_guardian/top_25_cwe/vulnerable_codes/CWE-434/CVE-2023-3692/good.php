
<?php

if (!FileSystemUtils::allowedFileExtension($_FILES['upload']['name'])) {
    $message = $gL10n->get('SYS_FILE_EXTENSION_INVALID');
}


if ($message === '') {
    try {
        $imagesPath = ADMIDIO_PATH . FOLDER_DATA . '/' . $folderName . '/images';

        FileSystemUtils::createDirectoryIfNotExists($imagesPath);

        // create a filename with a timestamp and 16 chars secure-random string,
        // so we have a scheme for the filenames and the risk of duplicates is negligible.
        // Format: 20180131-123456_0123456789abcdef.jpg
        $fileName = FileSystemUtils::getGeneratedFilename($_FILES['upload']['name']);
        $fileNamePath = $imagesPath . '/' . $fileName;

        $htmlUrl = SecurityUtils::encodeUrl(ADMIDIO_URL . '/adm_program/system/show_image.php', array('module' => $folderName, 'file' => $fileName));

        move_uploaded_file($_FILES['upload']['tmp_name'], $fileNamePath);

        // check if the file contains a valid image
        if (!getimagesize($fileNamePath)) {
            $message = $gL10n->get('PHO_PHOTO_FORMAT_INVALID');
            FileSystemUtils::deleteFileIfExists($fileNamePath);
        }

    } catch (RuntimeException|AdmException $exception) {
        $message = $exception->getMessage();
    }
}

// now call CKEditor function and send photo data
echo '<!DOCTYPE html>
<html>
    <body>
        <script type="text/javascript">
            window.parent.CKEDITOR.tools.callFunction('.$getCKEditorFuncNum.', "'.$htmlUrl.'", "'.$message.'")
        </script>
    </body>
</html>';